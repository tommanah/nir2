<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-capable' content='yes'>
    <link rel='stylesheet' href='css/common.css'>
    <title>Hit Test</title>
    <style>
        .model-select {
            position: fixed;
            top: 60px;
            left: 10px;
            z-index: 2000;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
        }

        .model-select select {
            padding: 8px;
            border-radius: 5px;
            border: none;
            background: white;
            font-size: 14px;
            width: 100%;
        }

        .model-select .buttons-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 5px;
        }

        .model-select .buttons-container button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: white;
            color: black;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
            -webkit-user-select: none;
            white-space: nowrap;
            flex: 1;
            text-align: center;
        }

        .model-select .buttons-container button.active {
            background: #4CAF50;
            color: white;
        }

        .ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .ui-container > * {
            pointer-events: auto;
        }

        #ARButton {
            position: fixed !important;
            bottom: 20px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            padding: 12px 24px !important;
            border: 1px solid #fff !important;
            border-radius: 4px !important;
            background: rgba(0, 0, 0, 0.8) !important;
            color: #fff !important;
            font: 13px sans-serif !important;
            text-align: center !important;
            outline: none !important;
            z-index: 999999 !important;
            cursor: pointer !important;
        }
    </style>
</head>
<body>
    <header>
        <details open>
            <summary>Hit Test</summary>
            <p>
                –≠—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ hit-testing –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—è—Ö.
            </p>
        </details>
    </header>

    <!-- –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è UI -->
    <div class="ui-container">
        <div class="model-select">
            <select id="modelSelect">
                <option value="sunflower">–ü–æ–¥—Å–æ–ª–Ω—É—Ö</option>
                <option value="cube">–ö—É–±</option>
                <option value="sphere">–°—Ñ–µ—Ä–∞</option>
            </select>
            <div class="buttons-container">
                <button id="placementButton" class="active">üì¶ –†–∞–∑–º–µ—Å—Ç–∏—Ç—å</button>
                <button id="editButton">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è WebXR
        import { Scene, WebGLRenderer, PerspectiveCamera, HemisphereLight, 
                BoxGeometry, SphereGeometry, CylinderGeometry, 
                MeshStandardMaterial, CircleGeometry,
                Mesh, Matrix4, Vector3 } from 'https://unpkg.com/three@0.128.0/build/three.module.js';
        import { ARButton } from 'https://unpkg.com/three@0.128.0/examples/jsm/webxr/ARButton.js';
        import { ARInteractionManager } from './js/render/core/ARInteractionManager.js';
        import { ARModeSelector } from './js/render/core/ARModeSelector.js';

        // XR –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let xrButton = null;
        let xrRefSpace = null;
        let xrViewerSpace = null;
        let xrHitTestSource = null;

        // –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
        let interactionManager = null;
        let modeSelector = null;

        // WebGL –∏ —Å—Ü–µ–Ω–∞
        let renderer = null;
        let scene = null;
        let camera = null;
        
        // –û–±—ä–µ–∫—Ç—ã –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        let arObject = null;
        let reticle = null;
        let shadow = null;
        
        // –ú–∞—Å—Å–∏–≤ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
        const MAX_OBJECTS = 30;
        let placedObjects = [];
        
        // –¢–∏–ø –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
        let selectedModelType = "sunflower";

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        init();

        function init() {
            // –°–æ–∑–¥–∞–µ–º —Å—Ü–µ–Ω—É –∏ –∫–∞–º–µ—Ä—É
            scene = new Scene();
            camera = new PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π WebXR
            renderer = new WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–µ—Ç –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
            const light = new HemisphereLight(0xffffff, 0xbbbbff, 1);
            light.position.set(0.5, 1, 0.25);
            scene.add(light);
            
            // –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã
            createObjects();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∏ —Å–µ–ª–µ–∫—Ç–æ—Ä —Ä–µ–∂–∏–º–æ–≤
            interactionManager = new ARInteractionManager();
            modeSelector = new ARModeSelector(interactionManager);
            
            // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ WebXR
            xrButton = ARButton.createButton(renderer, {
                requiredFeatures: ['hit-test'],
                optionalFeatures: ['dom-overlay'],
                domOverlay: { root: document.querySelector('.ui-container') }
            });
            document.body.appendChild(xrButton);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
            renderer.xr.addEventListener('sessionstart', onSessionStart);
            renderer.xr.addEventListener('sessionend', onSessionEnd);
            document.getElementById('modelSelect').addEventListener('change', onModelSelect);
            window.addEventListener('resize', onWindowResize);

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
            renderer.domElement.addEventListener('touchstart', (event) => {
                interactionManager.handleTouch(event, scene, () => {
                    if (reticle.visible) {
                        placeObject();
                    }
                });
                interactionManager.handlePinchStart(event);
            });

            renderer.domElement.addEventListener('touchmove', (event) => {
                interactionManager.handlePinchMove(event);
            });
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            renderer.setAnimationLoop(onXRFrame);
        }

        function createObjects() {
            // –°–æ–∑–¥–∞–µ–º reticle (–∫—Ä—É–∂–æ–∫ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è)
            reticle = new Mesh(
                new CircleGeometry(0.15, 32).rotateX(-Math.PI / 2),
                new MeshStandardMaterial({ color: 0x0099ff, transparent: true, opacity: 0.7 })
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);
            
            // –°–æ–∑–¥–∞–µ–º –∞—Ä—Å–µ–Ω–∞–ª –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
            arObject = getModelByType(selectedModelType);
            arObject.visible = false;
            scene.add(arObject);
        }

        function getModelByType(type) {
            let model;
            switch (type) {
                case 'cube':
                    model = new Mesh(
                        new BoxGeometry(0.15, 0.15, 0.15),
                        new MeshStandardMaterial({ color: 0x00ff00 })
                    );
                    break;
                case 'sphere':
                    model = new Mesh(
                        new SphereGeometry(0.1, 32, 32),
                        new MeshStandardMaterial({ color: 0xff0000 })
                    );
                    break;
                case 'sunflower':
                default:
                    model = new Mesh(
                        new CylinderGeometry(0.1, 0.1, 0.2, 32),
                        new MeshStandardMaterial({ color: 0xffff00 })
                    );
                    break;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–Ω—å –ø–æ–¥ –æ–±—ä–µ–∫—Ç
            const shadowMesh = new Mesh(
                new CircleGeometry(0.15, 32).rotateX(-Math.PI / 2),
                new MeshStandardMaterial({ color: 0x000000, transparent: true, opacity: 0.3 })
            );
            shadowMesh.position.y = -0.1;
            model.add(shadowMesh);
            
            return model;
        }

        function onSessionStart(event) {
            const session = event.target.getSession();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ (–∫–ª–∏–∫/–∫–∞—Å–∞–Ω–∏–µ)
            session.addEventListener('select', () => placeObject());
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –æ—Ç—Å—á–µ—Ç–∞
            session.requestReferenceSpace('viewer').then((refSpace) => {
                xrViewerSpace = refSpace;
                session.requestHitTestSource({ space: xrViewerSpace }).then((hitTestSource) => {
                    xrHitTestSource = hitTestSource;
                });
            });
            
            session.requestReferenceSpace('local').then((refSpace) => {
                xrRefSpace = refSpace;
            });
        }

        function onSessionEnd() {
            if (xrHitTestSource) {
                xrHitTestSource.cancel();
                xrHitTestSource = null;
            }
            xrRefSpace = null;
            xrViewerSpace = null;
        }

        function onModelSelect(event) {
            selectedModelType = event.target.value;
            
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –º–æ–¥–µ–ª—å –∏–∑ —Å—Ü–µ–Ω—ã
            if (arObject) {
                scene.remove(arObject);
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å
            arObject = getModelByType(selectedModelType);
            arObject.visible = false;
            scene.add(arObject);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onXRFrame(timestamp, frame) {
            if (!frame) return;
            
            const session = frame.session;
            const pose = frame.getViewerPose(xrRefSpace);
            
            reticle.visible = false;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º reticle —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
            if (xrHitTestSource && pose && interactionManager.mode === 'placement') {
                const hitTestResults = frame.getHitTestResults(xrHitTestSource);
                if (hitTestResults.length > 0) {
                    const hitPose = hitTestResults[0].getPose(xrRefSpace);
                    reticle.visible = true;
                    reticle.matrix.fromArray(hitPose.transform.matrix);
                }
            }
            
            if (pose) {
                renderer.render(scene, camera);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
        function placeObject() {
            if (interactionManager.mode === 'placement' && reticle.visible) {
                const newObject = getModelByType(selectedModelType);
                newObject.matrix.copy(reticle.matrix);
                newObject.matrix.decompose(newObject.position, newObject.quaternion, newObject.scale);
                newObject.position.y += 0.03;
                newObject.visible = true;
                scene.add(newObject);
                placedObjects.push(newObject);
                
                if (placedObjects.length > MAX_OBJECTS) {
                    const oldObject = placedObjects.shift();
                    scene.remove(oldObject);
                }
            }
        }
    </script>
</body>
</html>