<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>WebXR Hit Test</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        #menu {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
            font-family: Arial, sans-serif;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: white;
            font-size: 14px;
        }
        header {
            background-color: #f0f0f0;
            padding: 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 99;
        }
        details {
            margin-bottom: 15px;
        }
        summary {
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <details open>
            <summary>WebXR Hit Test</summary>
            <p>
                Разместите 3D объекты на реальных поверхностях с помощью WebXR.
            </p>
        </details>
    </header>

    <div id="menu">
        <select id="modelSelect">
            <option value="sunflower">Подсолнух</option>
            <option value="cube">Куб</option>
            <option value="sphere">Сфера</option>
        </select>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <script type="module">
        import { ARButton } from 'https://unpkg.com/three@0.128.0/examples/jsm/webxr/ARButton.js';

        // Глобальные переменные
        let container;
        let camera, scene, renderer, composer;
        let controller;
        let reticle;

        let hitTestSource = null;
        let hitTestSourceRequested = false;
        let currentModel = null;
        let selectedModelType = "sunflower";

        // Массив размещенных объектов
        const MAX_OBJECTS = 30;
        let placedObjects = [];

        // Инициализация сцены
        init();
        // Запуск анимации
        animate();

        function init() {
            container = document.createElement('div');
            document.body.appendChild(container);

            // Создаем сцену
            scene = new THREE.Scene();

            // Создаем камеру
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            // Настройка рендерера с поддержкой WebXR
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true
            });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            container.appendChild(renderer.domElement);

            // Добавляем свет для лучшей видимости объектов
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            light.position.set(0.5, 1, 0.25);
            scene.add(light);

            // Создаем эффект композитора для постобработки
            composer = new THREE.EffectComposer(renderer);
            const renderPass = new THREE.RenderPass(scene, camera);
            composer.addPass(renderPass);

            // Добавляем кнопку WebXR AR
            document.body.appendChild(
                ARButton.createButton(renderer, {
                    requiredFeatures: ['hit-test'],
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: document.getElementById('menu') }
                })
            );

            // Создаем контроллер для отслеживания касаний
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);

            // Создаем визуальный индикатор (reticle) для отображения результатов hit-test
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0x0099ff })
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            // Обработчик выбора модели
            document.getElementById('modelSelect').addEventListener('change', onModelSelect);

            // Слушатель изменения размера окна
            window.addEventListener('resize', onWindowResize);
        }

        // Обработчик выбора модели
        function onModelSelect(event) {
            selectedModelType = event.target.value;
        }

        // Создание модели в зависимости от выбранного типа
        function createModel(type) {
            switch (type) {
                case 'cube':
                    return new THREE.Mesh(
                        new THREE.BoxGeometry(0.15, 0.15, 0.15),
                        new THREE.MeshStandardMaterial({ color: 0x00ff00 })
                    );
                case 'sphere':
                    return new THREE.Mesh(
                        new THREE.SphereGeometry(0.1, 32, 32),
                        new THREE.MeshStandardMaterial({ color: 0xff0000 })
                    );
                case 'sunflower':
                default:
                    return new THREE.Mesh(
                        new THREE.CylinderGeometry(0.1, 0.1, 0.2, 32),
                        new THREE.MeshStandardMaterial({ color: 0xffff00 })
                    );
            }
        }

        // Обработчик события выбора (касание экрана)
        function onSelect() {
            if (reticle.visible) {
                // Создаем новую модель выбранного типа
                const model = createModel(selectedModelType);
                
                // Копируем позицию reticle в модель
                model.position.setFromMatrixPosition(reticle.matrix);
                
                // Немного приподнимаем модель над поверхностью
                model.position.y += 0.03;
                
                // Добавляем тень для реалистичности
                const shadow = new THREE.Mesh(
                    new THREE.CircleGeometry(0.15, 32).rotateX(-Math.PI / 2),
                    new THREE.MeshBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.3 })
                );
                shadow.position.copy(model.position);
                shadow.position.y -= 0.01; // Немного ниже объекта
                
                // Добавляем объект и тень в сцену
                scene.add(model);
                scene.add(shadow);
                
                // Сохраняем ссылки на объект и тень
                placedObjects.push({ model, shadow });
                
                // Ограничиваем количество объектов
                if (placedObjects.length > MAX_OBJECTS) {
                    const oldest = placedObjects.shift();
                    scene.remove(oldest.model);
                    scene.remove(oldest.shadow);
                }
            }
        }

        // Обработчик изменения размера окна
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        // Основной цикл анимации
        function animate() {
            renderer.setAnimationLoop(render);
        }

        // Функция рендеринга кадра
        function render(timestamp, frame) {
            if (frame) {
                // Получаем референсное пространство
                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = frame.session;

                // Запрашиваем источник hit-test при первом кадре
                if (!hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then((referenceSpace) => {
                        session.requestHitTestSource({ space: referenceSpace }).then((source) => {
                            hitTestSource = source;
                        });
                    });

                    hitTestSourceRequested = true;
                    session.addEventListener('end', () => {
                        hitTestSourceRequested = false;
                        hitTestSource = null;
                    });
                }

                // Обработка результатов hit-test
                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    
                    if (hitTestResults.length > 0) {
                        const hit = hitTestResults[0];
                        const pose = hit.getPose(referenceSpace);
                        
                        // Обновляем позицию reticle
                        reticle.visible = true;
                        reticle.matrix.fromArray(pose.transform.matrix);
                    } else {
                        reticle.visible = false;
                    }
                }
            }

            // Используем composer для рендеринга с эффектами (если нужно)
            if (composer && !renderer.xr.isPresenting) {
                composer.render();
            }
        }
    </script>
</body>
</html>